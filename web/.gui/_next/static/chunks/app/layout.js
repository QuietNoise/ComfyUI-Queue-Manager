(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{771:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>y});var n=r(5155),a=r(4233),l=r.n(a),s=r(5427),o=r.n(s);r(2514);var i=r(2115);async function u(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"POST",n=e.startsWith("https://")||e.startsWith("http://")?e:"".concat("/").concat(e);try{let e={method:r,headers:{"Content-Type":"application/json"}};"get"!==r.toLowerCase()&&(e.body=JSON.stringify(t));let a=await fetch(n,e);if(!a.ok)throw Error("Network response was not ok");let l=a.headers.get("content-type"),s=parseInt(a.headers.get("content-length"));if(0===s)return null;if(l.includes("application/json"))return await a.json();return await a.text()}catch(e){console.error("Error running apiCall:",e)}}let c=(0,i.createContext)(null);function d(e){let{data:t,isLoading:r,error:a,progress:l}=e,[s,o]=(0,i.useState)({pending:[],running:[]});function d(e){let{children:t,className:r,onClick:a}=e;return(0,n.jsx)("button",{className:"hover:bg-neutral-700 dark:text-neutral-200 rounded inline-flex items-center justify-center"+(r?" "+r:""),onClick:a,children:t})}function h(e){let{item:r,className:a,loader:l,index:s,mode:o}=e,{appStatus:h,setAppStatus:g}=(0,i.useContext)(c);async function f(){await u("api/".concat("running"===o?"interrupt":"queue"),{delete:[r[1]]})}async function m(){window.parent.postMessage({type:"QM_LoadWorkflow",workflow:r[3].extra_pnginfo.workflow,number:r[0]},"*")}async function p(){await u("queue_manager/archive",{archive:[r[3].db_id]})}async function x(){console.log("Playing item from client: "+h.clientId),await u("queue_manager/play",{items:[r[3].db_id],front:!0===h.shiftDown,clientId:h.clientId})}async function b(){g(e=>({...e,filters:{...h.filters,workflow:{type:"workflow",value:r[3].extra_pnginfo.workflow.id,valueLabel:r[3].extra_pnginfo.workflow.workflow_name}}}))}return(0,n.jsxs)("tr",{className:"dark:odd:bg-neutral-900 odd:bg-neutral-100"+(a?" "+a:""),children:[(0,n.jsxs)("td",{className:"px-3 py-1 serial",children:[(0,n.jsx)("span",{children:void 0!==s&&t.info?s+1+t.info.page*t.info.page_size:""}),l&&(0,n.jsx)("span",{className:"loader py-1 ",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"size-6",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"})})})]}),(0,n.jsx)("td",{className:"px-3 py-1 text-left name",children:(0,n.jsx)("button",{className:"plain",onClick:b,children:r[3].extra_pnginfo.workflow.workflow_name?r[3].extra_pnginfo.workflow.workflow_name:""})}),(0,n.jsxs)("td",{className:"px-3 py-1 text-right actions",children:[(0,n.jsx)(d,{className:"dark:bg-red-900 bg-rose-200 text-red-900",onClick:f,children:"Delete"}),(0,n.jsx)(d,{className:"dark:bg-green-900 bg-green-300",onClick:m,children:"Load"}),"queue"===h.route&&"running"!==o&&(0,n.jsx)(d,{className:"dark:bg-orange-900 bg-orange-200",onClick:p,children:"Archive"}),"archive"===h.route&&(0,n.jsxs)(d,{className:"run",onClick:x,children:[(0,n.jsxs)("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",children:[(0,n.jsx)("path",{className:"run",fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"m6 3l14 9l-14 9z"}),(0,n.jsxs)("g",{className:"run-first",fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",children:[(0,n.jsx)("path",{d:"M16 12H3m13 6H3m7-12H3m18 12V8a2 2 0 0 0-2-2h-5"}),(0,n.jsx)("path",{d:"m16 8l-2-2l2-2"})]})]}),"\xa0\xa0Run"]})]})]})}return((0,i.useEffect)(function(){t&&o({pending:t.pending?t.pending:[],running:t.running?t.running:[]})},[t]),a)?(0,n.jsxs)("p",{className:"text-red-500 text-center",children:["Loading failed: ",a]}):r||t&&(t.running.length||t.pending.length)?r&&!t?(0,n.jsx)("p",{className:"italic text-center",children:"Loading..."}):(0,n.jsx)("div",{className:"overflow-x-auto"+(r?" loading":""),style:{"--job-progress":l+"%"},children:(0,n.jsxs)("table",{className:"min-w-full border border-0",children:[(0,n.jsx)("thead",{className:"dark:bg-neutral-800 bg-neutral-200 text-xs uppercase",children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{className:"px-3 py-2 text-left",children:"#"}),(0,n.jsx)("th",{className:"px-3 py-2 text-left",children:"Workflow"}),(0,n.jsx)("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),(0,n.jsxs)("tbody",{children:[s.running.map(e=>(0,n.jsx)(h,{item:e,className:"running",loader:!0,mode:"running"},e[1])),s.pending.map((e,t)=>(0,n.jsx)(h,{item:e,className:"pending",index:t},e[3].db_id))]})]})}):(0,n.jsx)("p",{className:"italic text-center",children:"No items."})}let h="undefined"!=typeof window?i.useInsertionEffect||i.useLayoutEffect:()=>{};function g(){throw Error("INVALID_USEEVENT_INVOCATION: the callback from useEvent cannot be invoked before the component has mounted.")}let f=function(e){let t=i.useRef(g);h(()=>{t.current=e},[e]);let r=i.useRef(null);return r.current||(r.current=function(){return t.current.apply(this,arguments)}),r.current},m=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),p=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase()),x=e=>{let t=p(e);return t.charAt(0).toUpperCase()+t.slice(1)},b=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()},k=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};var w={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let j=(0,i.forwardRef)((e,t)=>{let{color:r="currentColor",size:n=24,strokeWidth:a=2,absoluteStrokeWidth:l,className:s="",children:o,iconNode:u,...c}=e;return(0,i.createElement)("svg",{ref:t,...w,width:n,height:n,stroke:r,strokeWidth:l?24*Number(a)/Number(n):a,className:b("lucide",s),...!o&&!k(c)&&{"aria-hidden":"true"},...c},[...u.map(e=>{let[t,r]=e;return(0,i.createElement)(t,r)}),...Array.isArray(o)?o:[o]])}),v=((e,t)=>{let r=(0,i.forwardRef)((r,n)=>{let{className:a,...l}=r;return(0,i.createElement)(j,{ref:n,iconNode:t,className:b("lucide-".concat(m(x(e))),"lucide-".concat(e),a),...l})});return r.displayName=x(e),r})("ellipsis-vertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);function y(e){let{children:t}=e,[r,a]=(0,i.useState)({loading:!0,error:null,queue:null,route:"queue",shiftDown:!1,clientId:null,filters:null}),[s,h]=(0,i.useState)({menuOpen:!1}),[g,m]=(0,i.useState)({id:null,nodes:{},integrity:!0,progress:0}),p=async e=>{a(e=>({...e,loading:!0,error:null}));try{var t;let n="";e&&(n="?page="+e),t=n=k(n),r.route&&(t+=(t?"&route=":"?route=")+r.route),n=t;let l=await fetch("".concat("/","queue_manager/queue")+n);if(!l.ok)throw Error("Network response was not ok");let s=await l.json();a(e=>({...e,loading:!1,error:null,queue:s}))}catch(e){a(t=>({...t,loading:!1,error:e.message,queue:null})),console.error("Error fetching "+r.route+" items:",e)}};function x(e){let t={};for(let r of e)r.id&&(t[r.id]=r.id);return t}function b(e,t){if(!t)return null;for(let r of t.running)if(r[1]===e)return r;for(let r of t.pending)if(r[1]===e)return r;return null}function k(e){return _()&&(e+=(e?"&filters=":"?filters=")+encodeURIComponent(JSON.stringify(r.filters))),e}async function w(){try{let e=k("");await fetch("".concat("/","queue_manager/archive-queue").concat(e))}catch(e){console.error("Error fetching queue items:",e)}}async function j(){await u("queue_manager/play-archive",{client_id:r.clientId,filters:_()?r.filters:null})}async function y(){let e=k("?route="+r.route);try{await fetch("".concat("/","queue_manager/queue").concat(e),{method:"DELETE"})}catch(e){console.error("Error deleting items from ".concat(r.route,":"),e)}}async function N(){u("queue_manager/takeover?client_id="+r.clientId,null,"GET")}function _(){return r.filters&&Object.keys(r.filters).length>0}let q=e=>{switch(e.data.message.name){case"status":"queue"===r.route&&p(r.queue&&r.queue.info?r.queue.info.page:0);break;case"execution_start":let{prompt_id:t}=e.data.message.detail,n=b(t,r.queue);if(n){let e=x(n[3].extra_pnginfo.workflow.nodes);m(r=>({...r,id:t,nodes:e,integrity:!0}));break}m(e=>({...e,id:t,integrity:!1,nodes:{}}));break;case"execution_cached":let{nodes:a}=e.data.message.detail;if(!a||0===a.length)return;let l={};for(let e of a)l[e]=!0;m(e=>({...e,nodes:{...e.nodes,...l}}));break;case"executing":let s=e.data.message.detail;if(!s)return;m(e=>({...e,nodes:{...e.nodes,[s]:!0}}));break;case"queue-manager-queue-updated":console.log("Queue Manager: queue updated: ",e.data.message),p()}},C=e=>{e&&"Shift"===e.key&&a(t=>({...t,shiftDown:e.isDown}))},L=f(e=>{switch(e.data.type){case"QM_queueStatusUpdated":q(e);break;case"QM_ParentKeypress":C(e.data.message);break;case"QM_QueueManager_Hello":a(t=>({...t,clientId:e.data.clientId}))}}),D=f(async e=>{if(!e.target.files||(e.target.files.length,0))return;let t=e.target.files[0],n=new FormData;n.append("queue_json",t),n.append("client_id",r.clientId),"archive"===r.route&&n.append("archive",!0);try{let t=await fetch("".concat("/","queue_manager/import"),{method:"POST",body:n});if(!t.ok)throw Error("Network response was not ok");let r=await t.json();console.log("Queue imported successfully",r),e.target.value=""}catch(e){console.error("Error importing queue:",e)}});return(0,i.useEffect)(()=>{p()},[r.filters]),(0,i.useEffect)(()=>{let e=Object.values(g.nodes).length>0?Math.round(Math.max(Object.values(g.nodes).filter(e=>"boolean"==typeof e).length-1,0)/Object.values(g.nodes).length*100,2):0;m(t=>({...t,progress:e}))},[g.nodes]),(0,i.useEffect)(()=>{if(g.id&&!1===g.integrity){let e=b(g.id,r.queue);if(e){let t=x(e[3].extra_pnginfo.workflow.nodes);for(let e in g.nodes)!0===g.nodes[e]&&(t[e]=!0);m(e=>({...e,nodes:t,integrity:!0}))}}},[r.queue]),(0,i.useEffect)(()=>{a(e=>({...e,queue:null})),p()},[r.route]),(0,i.useEffect)(()=>(p(),window.addEventListener("message",L),window.addEventListener("keydown",e=>{a(e=>({...e,shiftDown:!0}))}),window.addEventListener("keyup",e=>{a(e=>({...e,shiftDown:!1}))}),window.parent.postMessage({type:"QM_QueueManager_Hello"},"*"),()=>window.removeEventListener("message",L)),[]),(0,n.jsx)(c.Provider,{value:{appStatus:r,setAppStatus:a},children:(0,n.jsxs)("html",{lang:"en",children:[(0,n.jsxs)("head",{children:[(0,n.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,n.jsx)("title",{children:"Queue Manager"}),(0,n.jsx)("meta",{name:"description",content:"ComfyUI Queue Manager frontend"})]}),(0,n.jsxs)("body",{className:"".concat(l().variable," ").concat(o().variable," route-").concat(r.route),children:[(0,n.jsx)("button",{className:"top-menu-toggle"+(s.menuOpen?" open":""),onClick:function(){h(e=>({...e,menuOpen:!e.menuOpen}))},children:(0,n.jsx)("span",{children:(0,n.jsx)(v,{})})}),(0,n.jsx)("section",{className:"top-menu"+(s.menuOpen?" open":""),children:(0,n.jsx)("div",{className:"container",children:(0,n.jsx)("button",{className:"button",onClick:N,children:"\uD83C\uDFAF Take over focus"})})}),(0,n.jsxs)("div",{className:"tabs",children:[(0,n.jsx)("button",{className:"tab"+("queue"===r.route?" dark:bg-neutral-800 bg-neutral-200 active":""),onClick:()=>{a(e=>({...e,route:"queue"}))},children:"Queue"}),(0,n.jsx)("button",{className:"tab archive"+("archive"===r.route?" active":""),onClick:()=>{a(e=>({...e,route:"archive"}))},children:"Archive"}),(0,n.jsx)("button",{className:"tab completed"+("completed"===r.route?" active":""),onClick:()=>{a(e=>({...e,route:"completed"}))},children:"Completed"})]}),_()&&(0,n.jsxs)("div",{className:"filters flex items-center p-2",children:[(0,n.jsx)("span",{className:"text-neutral-500",children:"Filters:"}),Object.values(r.filters).map(e=>(0,n.jsxs)("div",{className:"filter flex items-center",children:[(0,n.jsxs)("span",{className:"inline-flex text-neutral-800 dark:text-neutral-200 close label",children:[(0,n.jsxs)("span",{className:"type",children:[e.type+": ","\xa0"]}),e.valueLabel]}),(0,n.jsx)("button",{className:"dark:bg-neutral-700 bg-neutral-400 text-neutral-200 light:text-neutral-800 close hover:bg-neutral-500",onClick:()=>{a(t=>({...t,filters:(t=>{let{[e.type]:r,...n}=t;return n})(t.filters)}))},children:(0,n.jsx)("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",children:(0,n.jsx)("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"})})})]},e.type)),(0,n.jsxs)("button",{className:"dark:bg-neutral-700 bg-neutral-400 text-neutral-200 light:text-neutral-800 close close-all hover:bg-neutral-500 ml-auto",onClick:()=>{a(e=>({...e,filters:null}))},children:[(0,n.jsx)("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",children:(0,n.jsx)("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"})}),"Clear filters"]})]}),(0,n.jsx)("div",{className:"queue-table"+(r.shiftDown?" shift-down":""),children:(0,n.jsx)(d,{data:r.queue,error:r.error,isLoading:r.loading,progress:g.progress,route:r.route,shiftDown:r.shiftDown})}),(0,n.jsxs)("footer",{className:"footer",children:[(0,n.jsx)("div",{className:"paging flex",children:r.queue&&r.queue.info&&r.queue.info.last_page>0&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{className:"page"+(0===r.queue.info.page?" disabled":""),onClick:()=>{a(e=>({...e,queue:null})),p(r.queue.info.page-1)},disabled:0===r.queue.info.page,children:" << "}),(0,n.jsx)("div",{className:"pages flex justify-center flex-1",children:Array.from({length:r.queue.info.last_page+1},(e,t)=>(0,n.jsx)("button",{className:"page"+(r.queue.info.page===t?" active":""),onClick:()=>{a(e=>({...e,queue:null})),p(t)},children:t+1},t))}),(0,n.jsx)("button",{className:"page"+(r.queue.info.page===r.queue.info.last_page?" disabled":""),onClick:()=>{a(e=>({...e,queue:null})),p(r.queue.info.page+1)},disabled:r.queue.info.page===r.queue.info.last_page,children:" >> "})]})}),(0,n.jsxs)("div",{className:"p-2 flex actions",children:[r.queue&&(r.queue.running.length>0||r.queue.pending.length>0)&&(0,n.jsxs)(n.Fragment,{children:["queue"===r.route&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("button",{onClick:w,className:"hover:bg-neutral-700 bg-orange-200 py-1 px-2 rounded mr-1 border-0 dark:bg-orange-900",children:["Archive All ",_()?"*":"Pending"]}),(0,n.jsxs)("a",{href:"/queue_manager/export"+k(""),className:"hover:bg-neutral-700 dark:bg-teal-700 bg-teal-200 text-neutral-900 py-1 px-2 rounded mr-1 border-0 ",children:["\uD83D\uDCE4 Export ",_()?"*":"Queue"]}),_()&&(0,n.jsx)("button",{onClick:y,className:"hover:bg-neutral-700 dark:bg-gray-800 bg-gray-200 dark:text-neutral-200 text-neutral-800 py-1 px-2 rounded mr-1 border-0 order-last ml-auto",children:"\uD83D\uDDD1️ Delete All *"})]}),"archive"===r.route&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("button",{onClick:j,className:"hover:bg-neutral-700 text-neutral-200 dark:text-neutral-900 py-1 px-2 rounded mr-1 border-0 run run-all",children:[(0,n.jsx)("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",children:(0,n.jsx)("path",{className:"run",fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"m6 3l14 9l-14 9z"})}),"Run All ",_()?"*":""]}),(0,n.jsxs)("a",{href:"/queue_manager/export"+k("?route=archive"),className:"hover:bg-neutral-700 dark:bg-teal-700 bg-teal-200 text-neutral-900  py-1 px-2 rounded mr-1 border-0",children:["\uD83D\uDCE4 Export ",_()?"*":"Archive"]}),(0,n.jsxs)("button",{onClick:y,className:"hover:bg-neutral-700 dark:bg-gray-800 bg-gray-200 dark:text-neutral-200 text-neutral-800 py-1 px-2 rounded mr-1 border-0 order-last ml-auto",children:["\uD83D\uDDD1️ Delete ",_()?"All *":"All Archive"]})]}),"completed"===r.route&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("a",{href:"/queue_manager/export"+k("?route=completed"),className:"hover:bg-neutral-700 dark:bg-teal-700 bg-teal-200 text-neutral-900  py-1 px-2 rounded mr-1 border-0",children:["\uD83D\uDCE4 Export ",_()?"*":"Completed"]}),(0,n.jsxs)("button",{onClick:y,className:"hover:bg-neutral-700 dark:bg-gray-800 bg-gray-200 dark:text-neutral-200 text-neutral-800 py-1 px-2 rounded mr-1 border-0 order-last ml-auto",children:["\uD83D\uDDD1️ Delete ",_()?"All *":"All Completed"]})]})]}),["queue","archive"].includes(r.route)&&(0,n.jsxs)("form",{method:"post",encType:"multipart/form-data",className:"import-form",children:[(0,n.jsx)("input",{id:"uploadQueueForm",type:"file",name:"queue_json",accept:".json",required:!0,hidden:!0,onChange:D}),(0,n.jsxs)("label",{htmlFor:"uploadQueueForm",className:"hover:bg-neutral-700 py-1 px-2 rounded mr-1 border-0 dark:bg-teal-900 bg-teal-300",children:["\uD83D\uDCC1 Import ","queue"===r.route?"Queue":"Archive"]})]})]})]})]})]})})}},2514:()=>{},4233:e=>{e.exports={style:{fontFamily:"'Geist', 'Geist Fallback'",fontStyle:"normal"},className:"__className_2b89fc",variable:"__variable_2b89fc"}},5427:e=>{e.exports={style:{fontFamily:"'Geist Mono', 'Geist Mono Fallback'",fontStyle:"normal"},className:"__className_1479a9",variable:"__variable_1479a9"}},6042:(e,t,r)=>{Promise.resolve().then(r.bind(r,771))}},e=>{var t=t=>e(e.s=t);e.O(0,[449],()=>t(6042)),_N_E=e.O()}]);